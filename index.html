<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Code Scanner</title>
  <script src="js/html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    #reader {
      width: 300px;
      height: 300px;
      margin: 0 auto;
      border: 1px solid #ccc;
    }
    #status, #decoded-message {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
    }
    #register-section {
      margin-top: 30px;
      display: none;
    }
    input, button {
      font-size: 18px;
      padding: 10px;
      margin: 10px;
    }
    #code-result {
      font-size: 20px;
      color: green;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>QR Code Scanner</h1>

  <div id="reader"></div>
  <p id="status">Initializing scanner...</p>
  <p id="decoded-message"></p>

  <!-- Register section (hidden initially) -->
  <div id="register-section">
    <input type="text" id="registerNumber" placeholder="Enter Register Number">
    <button onclick="submitRegisterNumber()">Generate Code</button>
    <p id="loadingMessage" style="color: blue; display: none;">Cooking up some spicy digits, hang tight...</p>
    <p id="code-result"></p>
  </div>

  <script>
    const targetUrl = "https://www.youtube.com/";
    const apiEndpoint = "https://d755-2401-4900-67b7-9d1e-28e8-7b8f-5d8c-93bf.ngrok-free.app/register";

    let html5QrCode;

    function onScanSuccess(decodedText) {
      document.getElementById("decoded-message").innerText = `Decoded Message: ${decodedText}`;

      if (decodedText === targetUrl) {
        document.getElementById("status").innerText = "‚úÖ Valid QR Code scanned.";

        // Stop scanner and show register input
        stopScanner();
        document.getElementById("register-section").style.display = "block";
      } else {
        document.getElementById("status").innerText = "‚ùå Invalid QR Code. Try again.";
      }
    }

    function onScanFailure(error) {
      console.warn("Scan failed:", error);
    }

    async function initializeScanner() {
      document.getElementById("status").innerText = "Initializing scanner...";
      html5QrCode = new Html5Qrcode("reader");

      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras.length === 0) {
          document.getElementById("status").innerText = "No camera found. Connect a webcam.";
          return;
        }

        const backCamera = cameras.find(cam => cam.label.toLowerCase().includes("back")) || cameras[0];

        await html5QrCode.start(
          backCamera.id,
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        );

        document.getElementById("status").innerText = "Scan the QR like it‚Äôs sacred üßò";
      } catch (err) {
        console.error("Error initializing scanner:", err);
        document.getElementById("status").innerText = `Error: ${err.message}`;
      }
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById("status").innerText = "Scanner stopped.";
        }).catch(err => {
          console.error("Error stopping scanner:", err);
        });
      }
    }

    async function submitRegisterNumber() {
      const registerNumber = document.getElementById("registerNumber").value.trim();
      const loadingMessage = document.getElementById("loadingMessage");
      const codeResult = document.getElementById("code-result");

      if (!registerNumber) {
        alert("Enter your register number, soldier!");
        return;
      }

      loadingMessage.style.display = "block";
      codeResult.innerText = "";

      try {
        const response = await fetch(apiEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ registerNumber })
        });

        const data = await response.json();

        if (data.success) {
          codeResult.innerText = `üéâ Your Code: ${data.code}`;
          setTimeout(() => {
            window.location.href = targetUrl;
          }, 3000);
        } else {
          alert(`‚ùå Error: ${data.message || "Failed to generate code."}`);
        }
      } catch (error) {
        alert("‚ùå Server error. Please try again.");
      } finally {
        loadingMessage.style.display = "none";
      }
    }

    window.addEventListener("load", initializeScanner);
  </script>
</body>
</html>
