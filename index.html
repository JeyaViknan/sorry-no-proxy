<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
  <title>QR Code Attendance</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="js/html5-qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>QR Code Attendance</h1>
  </header>

  <main>
    <!-- QR Scanner -->
    <div id="reader-container">
      <div id="reader"></div>
    </div>
    <p id="status">Initializing scanner...</p>

    <!-- Section visible after QR is verified -->
    <section id="register-section" style="display: none;">
      <p class="success-text">QR Code Verified</p>
      <input type="text" id="registerNumber" placeholder="Enter Enrollment Number">
      <div id="camera-controls"></div>
      <p id="loadingMessage" style="display:none;">Processing your attendance...</p>
      <p id="code-result"></p>
    </section>
  </main>

  <script>
    const baseText = "jeycavbhakanadiyaz"; // your secret text
    const apiEndpoint = "http://localhost:8000/verify-attendance";

    let html5QrCode;
    let qrScanned = false;

    // Generate valid QR formats for now + next few minutes
    function getCurrentTimeFormats() {
      const now = new Date();
      const validFormats = [];
      for (let i = 0; i <= 4; i++) {
        const t = new Date(now.getTime() + i * 60000);
        const h = String(t.getHours()).padStart(2, '0');
        const m = String(t.getMinutes()).padStart(2, '0');
        validFormats.push(baseText + h + m);
      }
      return validFormats;
    }

    function isValidQRCode(decodedText) {
      return getCurrentTimeFormats().includes(decodedText);
    }

    async function initializeScanner() {
      html5QrCode = new Html5Qrcode("reader");
      try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) {
          document.getElementById("status").innerText = "No camera found.";
          return;
        }
        const backCamera = cameras.find(c => c.label.toLowerCase().includes("back")) || cameras[0];
        await html5QrCode.start(
          backCamera.id,
          { fps: 10, videoConstraints: { facingMode: "environment" } },
          onScanSuccess,
          onScanFailure
        );
        document.getElementById("status").innerText = "Point your phone at the QR code";
      } catch (err) {
        document.getElementById("status").innerText = `Error: ${err.message}`;
      }
    }

    function stopScanner() {
      if (html5QrCode) html5QrCode.stop().catch(console.error);
    }

    function onScanSuccess(decodedText) {
      if (!qrScanned && isValidQRCode(decodedText)) {
        qrScanned = true;
        document.getElementById("status").innerText = "✅ QR Verified.";
        document.getElementById("reader").style.display = "none";
        document.getElementById("register-section").style.display = "block";
        stopScanner();

        // Show button to open front camera
        const btn = document.createElement("button");
        btn.innerText = "Open Camera";
        btn.onclick = openFrontCamera;
        document.getElementById("camera-controls").appendChild(btn);
      } else {
        document.getElementById("status").innerText = "❌ Invalid QR. Try again.";
      }
    }

    function onScanFailure(error) {
      console.warn("Scan error:", error);
    }

    // ============= FRONT CAMERA CAPTURE =============
    let videoStream, videoElement;

    async function openFrontCamera() {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      videoElement = document.createElement("video");
      videoElement.autoplay = true;
      videoElement.srcObject = videoStream;
      videoElement.style.width = "100%";
      document.getElementById("camera-controls").innerHTML = ""; // clear old button
      document.getElementById("camera-controls").appendChild(videoElement);

      // Add capture button
      const captureBtn = document.createElement("button");
      captureBtn.innerText = "Capture Image";
      captureBtn.onclick = captureImage;
      document.getElementById("camera-controls").appendChild(captureBtn);
    }

    async function captureImage() {
      const canvas = document.createElement("canvas");
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;
      canvas.getContext("2d").drawImage(videoElement, 0, 0);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
      videoStream.getTracks().forEach(track => track.stop());
      videoElement.remove();

      const reg = document.getElementById("registerNumber").value.trim();
      if (!reg) {
        alert("Enter your enrollment number first!");
        return;
      }

      document.getElementById("loadingMessage").style.display = "block";

      const formData = new FormData();
      formData.append("registerNumber", reg);
      formData.append("file", blob, "frame.jpg");

      const res = await fetch(apiEndpoint, { method: "POST", body: formData });
      const data = await res.json();

      document.getElementById("loadingMessage").style.display = "none";
      document.getElementById("code-result").innerText = data.message;
    }

    window.addEventListener("load", initializeScanner);
  </script>
</body>
</html>
