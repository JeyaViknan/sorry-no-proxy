<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Code Scanner</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="js/html5-qrcode.min.js"></script>
  <style>
    input, button {
      touch-action: manipulation;
    }

    body {
      touch-action: none; /* So we can handle gestures manually */
      overscroll-behavior: contain;
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }

    #status {
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <header>
    <h1>QR Code Scanner</h1>
  </header>

  <main>
    <div id="reader-container">
      <div id="reader"></div>
    </div>

    <p id="status">Initializing scanner...</p>

    <section id="register-section" style="display: none;">
      <p class="success-text">QR Code Verified</p><br>
      <input type="text" id="registerNumber" placeholder="Enter Register Number"><br><br>
      <button id="getCodeBtn" onclick="submitRegisterNumber()">Get Code</button>
      <p id="loadingMessage" style="display:none;">Cooking up some spicy digits, hang tight...</p>
      <p id="code-result"></p>
    </section>
  </main>

  <script>
    const targetUrl = "https://qrfy.io/QlU4rjtldc";
    const apiEndpoint = "https://fdd0-2401-4900-4dfd-fa47-95dc-3886-f643-7f8f.ngrok-free.app/register";

    let html5QrCode;
    let qrScanned = false;
    let currentZoom = 1;

    function onScanSuccess(decodedText) {
      if (!qrScanned && decodedText.trim().includes(targetUrl)) {
        qrScanned = true;
        document.getElementById("status").innerText = "You made it.";
        document.getElementById("reader-container").style.display = "none";
        document.getElementById("register-section").style.display = "block";
        stopScanner();
      } else {
        document.getElementById("status").innerText = "Hold your QR like it's Simba in Lion King. Yes, that high.";
      }
    }

    function onScanFailure(error) {
      console.warn("QR scan failed:", error);
    }

    async function initializeScanner() {
      html5QrCode = new Html5Qrcode("reader");

      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras.length === 0) {
          document.getElementById("status").innerText = "No camera found.";
          return;
        }

        const backCamera = cameras.find(cam => cam.label.toLowerCase().includes("back")) || cameras[0];

        await html5QrCode.start(
          backCamera.id,
          {
            fps: 10,
            qrbox: { width: 300, height: 300 },
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true
            },
            videoConstraints: {
              facingMode: "environment",
              advanced: [{ zoom: currentZoom }]
            }
          },
          onScanSuccess,
          onScanFailure
        );

        document.getElementById("status").innerText = "Point your phone close to the QR";

      } catch (err) {
        document.getElementById("status").innerText = `Error: ${err.message}`;
      }
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(err => {
          console.error("Error stopping scanner:", err);
        });
      }
    }

    async function submitRegisterNumber() {
      const registerNumber = document.getElementById("registerNumber").value.trim();
      const loadingMessage = document.getElementById("loadingMessage");
      const codeResult = document.getElementById("code-result");
      const getCodeBtn = document.getElementById("getCodeBtn");

      if (!registerNumber) {
        alert("You canâ€™t ghost your identity. Type that reg number in.");
        return;
      }

      getCodeBtn.style.display = "none";
      loadingMessage.style.display = "block";
      codeResult.innerText = "";

      try {
        const response = await fetch(apiEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ registerNumber })
        });

        const data = await response.json();

        if (data.success) {
          codeResult.innerText = `Your Code: ${data.code}`;
          setTimeout(() => {
            window.location.href = targetUrl;
          }, 3000);
        } else {
          alert(data.message || "Code generation failed.");
        }
      } catch (error) {
        alert("Server error. Try again later.");
      } finally {
        loadingMessage.style.display = "none";
      }
    }

    // -------- PINCH TO ZOOM SUPPORT --------
    let initialPinchDistance = null;

    document.addEventListener("touchstart", (e) => {
      if (e.touches.length === 2) {
        initialPinchDistance = getDistance(e.touches);
      }
    }, { passive: false });

    document.addEventListener("touchmove", async (e) => {
      if (e.touches.length === 2 && initialPinchDistance) {
        e.preventDefault();
        const newDistance = getDistance(e.touches);
        const delta = newDistance - initialPinchDistance;

        let newZoom = currentZoom + delta * 0.01;
        newZoom = Math.max(1, Math.min(3, newZoom)); // clamp between 1x and 3x zoom

        try {
          await html5QrCode.applyVideoConstraints({
            advanced: [{ zoom: newZoom }]
          });
          currentZoom = newZoom;
          initialPinchDistance = newDistance;
        } catch (err) {
          console.warn("Pinch zoom failed:", err);
        }
      }
    }, { passive: false });

    function getDistance(touches) {
      const [t1, t2] = touches;
      return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
    }

    window.addEventListener("load", initializeScanner);
  </script>
</body>
</html>
